<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - Dashboard</title>
    <link rel="icon" type="image/png" href="/static/images/boom.png">
    <link rel="stylesheet" href="/static/css/main.css">
    
    <!-- Initialize Clerk -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="{{.clerkPublishableKey}}"
        src="{{.clerkFrontendApiUrl}}/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript"
    ></script>
</head>
<body>
    <div class="dashboard-page">
        <header class="dashboard-header">
            <div class="container">
                <div class="dashboard-header-content">
                    <div class="dashboard-logo">
                        <a href="/" class="logo-link">
                            <img src="/static/images/logo-sm.png" alt="Disko" class="logo-image">
                        </a>
                    </div>
                    <div class="user-menu">
                        <div id="clerk-user-button"></div>
                        <button id="sign-out-btn" class="btn btn-secondary">Sign Out</button>
                        <span class="version-display">v{{.version}}</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="dashboard-main">
            <div class="container">
                <!-- Welcome Section -->
                <div class="welcome-section">
                    <h2>Welcome back! üöÄ</h2>
                    <p>Manage your project boards and share progress with your customers.</p>
                </div>

                <div class="dashboard-actions">
                    <button id="create-board-btn" class="btn btn-primary">
                        <span>‚ú®</span>
                        Create New Board
                    </button>
                </div>

                <section class="boards-section">
                    <div class="section-header">
                        <h2>Your Boards</h2>
                        <div class="section-stats">
                            <span class="stat-item">
                                <span class="stat-number" id="boards-count">0</span>
                                <span class="stat-label">Total Boards</span>
                            </span>
                            <span class="stat-item">
                                <span class="stat-number" id="ideas-count">0</span>
                                <span class="stat-label">Total Ideas</span>
                            </span>
                        </div>
                    </div>
                    <div id="boards-list" class="boards-grid">
                        <!-- Boards will be loaded here -->
                        <div class="loading">Loading your boards...</div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Create Board Modal -->
        <div id="create-board-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚ú® Create New Board</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="create-board-form">
                    <div class="form-group">
                        <label for="board-title">Board Title *</label>
                        <input type="text" id="board-title" name="title" required maxlength="100" placeholder="Enter board title">
                    </div>
                    <div class="form-group">
                        <label for="board-description">Description</label>
                        <textarea id="board-description" name="description" rows="3" maxlength="500" placeholder="Optional description for your board"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCreateBoardModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Board</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Board Confirmation Modal -->
        <div id="delete-board-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üóëÔ∏è Delete Board</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the board "<strong id="delete-board-name"></strong>"?</p>
                    <p class="warning-text">‚ö†Ô∏è This action cannot be undone. All ideas in this board will also be deleted.</p>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteBoardModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn" onclick="deleteBoard()">Delete Board</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <img src="/static/images/logo-sm-white.png" alt="Disko" class="logo-image">
                    </div>
                    <p>Empowering entrepreneurs to share progress and build trust with customers through beautiful, interactive project boards.</p>
                </div>
                <div class="footer-section">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="/terms">Terms of Service</a></li>
                        <li><a href="/privacy">Privacy Policy</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <ul>
                        <li><a href="/contact">Contact Us</a></li>
                        <li><a href="mailto:support@disko.app">Support</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Disko. A Nomadis Service. All rights reserved. | v{{.version}}</p>
            </div>
        </div>
    </footer>

    <!-- Common JavaScript -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/dashboard.js"></script>
    <script src="/static/js/idea-management.js"></script>
    
    <script>
        // Wait for Clerk to be available
        function waitForClerk(timeout = 10000) {
            const start = Date.now();
            return new Promise((resolve, reject) => {
                function checkClerk() {
                    if (window.Clerk === undefined) {
                        if (Date.now() - start > timeout) {
                            console.error('Clerk failed to load within timeout');
                            reject(new Error('Timeout waiting for Clerk to load'));
                            return;
                        }
                        setTimeout(checkClerk, 100);
                        return;
                    }
                    console.log('Clerk loaded successfully');
                    resolve(window.Clerk);
                }
                checkClerk();
            });
        }

        // Initialize Clerk and handle authentication
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                console.log('Initializing Clerk...');
                const Clerk = await waitForClerk();
                
                if (!Clerk) {
                    throw new Error('Clerk failed to initialize');
                }

                await Clerk.load({
                    afterLoad: (Clerk) => {
                        console.log('Clerk loaded, setting up dashboard...');
                    }
                });

                // Check if user is signed in
                const user = await Clerk.user;
                if (!user) {
                    console.log('User not signed in, redirecting to landing page...');
                    window.location.href = '/';
                    return;
                }

                // Update user name display
                const userNameElement = document.getElementById('user-name');
                if (userNameElement) {
                    const displayName = user.firstName || user.emailAddresses[0]?.emailAddress || 'User';
                    userNameElement.textContent = `üë§ ${displayName}`;
                }

                // Mount user button
                const userButtonElement = document.getElementById('clerk-user-button');
                if (userButtonElement) {
                    await Clerk.mountUserButton(userButtonElement, {
                        afterSignOutUrl: "/",
                        appearance: {
                            elements: {
                                rootBox: "inline-block",
                                userButtonBox: "rounded-full border border-gray-200 p-1 hover:bg-gray-50 transition-colors duration-200",
                                userButtonTrigger: "flex items-center gap-2",
                                userButtonAvatarBox: "w-8 h-8 rounded-full overflow-hidden",
                                userButtonPopoverCard: "bg-white rounded-2xl shadow-lg border border-gray-100 p-6",
                                userButtonPopoverActions: "space-y-2",
                                userButtonPopoverActionButton: "w-full text-left px-4 py-2 rounded-xl hover:bg-gray-50 transition-colors duration-200"
                            }
                        }
                    });
                    console.log('Clerk user button mounted successfully');
                }

                // Setup sign out button
                const signOutBtn = document.getElementById('sign-out-btn');
                if (signOutBtn) {
                    signOutBtn.addEventListener('click', async () => {
                        try {
                            await Clerk.signOut();
                            window.location.href = '/';
                        } catch (error) {
                            console.error('Failed to sign out:', error);
                        }
                    });
                }

                // Listen for authentication state changes
                Clerk.addListener(({ user }) => {
                    if (!user) {
                        console.log('User signed out, redirecting to landing page...');
                        window.location.href = '/';
                    }
                });

                console.log('Dashboard authentication setup complete');

                // Now that Clerk is initialized, load the boards
                console.log('Loading boards after Clerk initialization...');
                await loadBoards();

            } catch (error) {
                console.error('Failed to initialize Clerk:', error.message);
                // Redirect to landing page if authentication fails
                window.location.href = '/';
            }
        });
    </script>
</body>
</html>