<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}} - Board {{.boardId}}</title>
    <link rel="icon" type="image/png" href="/static/images/boom.png">
    <link rel="stylesheet" href="/static/css/main.css">
    
    <!-- Initialize Clerk -->
    <script
      async
      crossorigin="anonymous"
        data-clerk-publishable-key="{{.clerkPublishableKey}}"
        src="{{.clerkFrontendApiUrl}}/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
      type="text/javascript"
    ></script>
</head>
<body>
        <div class="board-page">
            <header class="dashboard-header">
                <div class="container">
                    <div class="dashboard-header-content">
                        <div class="dashboard-logo">
                            <a href="/" class="logo-link">
                                <img src="/static/images/logo-sm.png" alt="Disko" class="logo-image">
                            </a>
                        </div>
                        <div class="user-menu">
                            <div id="clerk-user-button"></div>
                            <button id="sign-out-btn" class="btn btn-secondary">Sign Out</button>
                            <span class="version-display">v{{.version}}</span>
                        </div>
                    </div>
                </div>
            </header>

            <main class="dashboard-main">
                <div class="container">
                    <!-- Board Info Section -->
                    <div class="board-info-section">
                        <div class="board-info">
                            <h1 id="board-title">Loading...</h1>
                            <p id="board-description"></p>
                            <div id="board-status" class="board-status">
                                <!-- Status indicator will be populated by JavaScript -->
                            </div>
                            <div id="ws-status" class="ws-status reconnecting">Connecting...</div>
                        </div>
                        <div class="board-actions">
                            {{if not .isPublic}}
                            <button id="board-settings-btn" class="btn btn-secondary">‚öôÔ∏è Settings</button>
                            {{end}}
                            <button id="invite-btn" class="btn btn-secondary" disabled>üìß Invite</button>
                            <button id="refresh-btn" class="btn btn-secondary">Refresh</button>
                        </div>
                    </div>

                    <div class="board-container">
                        <!-- Tab Navigation -->
                        <div class="board-tabs">
                            <button id="board-tab" class="tab-button active" data-tab="board">
                                <span class="tab-icon">üìã</span>
                                Board
                                <span id="board-ideas-count" class="tab-count">0</span>
                            </button>
                            <button id="release-tab" class="tab-button" data-tab="release">
                                <span class="tab-icon">üöÄ</span>
                                Release
                                <span id="release-ideas-count" class="tab-count">0</span>
                            </button>
                        </div>

                        <!-- Board View -->
                        <div id="board-view" class="tab-content active">
                            <div class="board-header-info">
                                <h2>Board</h2>
                                <div class="board-count-section">
                                    <span id="ideas-count" class="ideas-count">Loading...</span>
                                    <div class="board-sort-controls">
                                        <select id="global-sort" class="sort-select">
                                            <option value="">Sort by...</option>
                                            <option value="name-asc">Name A-Z</option>
                                            <option value="name-desc">Name Z-A</option>
                                            <option value="rice-desc">RICE Score ‚Üì</option>
                                            <option value="rice-asc">RICE Score ‚Üë</option>
                                            <option value="status-progress">In Progress First</option>
                                            <option value="created-desc">Newest First</option>
                                            <option value="created-asc">Oldest First</option>
                                        </select>
                                    </div>
                                    {{if not .isPublic}}
                                    <button id="create-idea-btn" class="btn btn-primary create-idea-btn">Create Idea</button>
                                    {{end}}
                                </div>
                            </div>
                            <div id="drag-drop-board" class="drag-drop-board">
                                <!-- Column layout will be loaded here -->
                                <div class="board-loading">Loading board...</div>
                            </div>
                        </div>

                        <!-- Release View -->
                        <div id="release-view" class="tab-content">
                            <div class="release-header">
                                <h2>Released Ideas</h2>
                                <div class="release-controls">
                                    <div class="search-container">
                                        <input type="text" id="release-search" placeholder="Search released ideas..." class="search-input">
                                        <button id="clear-search" class="clear-search-btn" title="Clear search">√ó</button>
                                    </div>
                                    <div class="sort-container">
                                        <select id="release-sort" class="sort-select">
                                            <option value="created_at:desc">Newest First</option>
                                            <option value="created_at:asc">Oldest First</option>
                                            <option value="name:asc">Name A-Z</option>
                                            <option value="name:desc">Name Z-A</option>
                                        </select>
                                </div>
                            </div>
                        </div>
                        <div id="release-table-container" class="release-table">
                            <!-- Release table will be loaded here -->
                                <div class="release-loading">Loading released ideas...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
    </div>

    <!-- Common JavaScript -->
    <script src="/static/js/api.js"></script>
    <script src="/static/js/board.js"></script>
    <script src="/static/js/board-tabs.js"></script>
    <script src="/static/js/drag-drop-board.js"></script>
    <script src="/static/js/idea-management.js"></script>
    <script src="/static/js/board-settings.js"></script>
    <script src="/static/js/release-table.js"></script>
    <script src="/static/js/search-bar.js"></script>
    <script src="/static/js/websocket-manager.js"></script>
    
    <script>
        // Board data from server
        window.boardData = {
            boardId: '{{.boardID}}',
            isAdmin: false, // Will be determined by API call
            publicLink: null
        };

        // Wait for Clerk to be available
        function waitForClerk(timeout = 10000) {
            const start = Date.now();
            return new Promise((resolve, reject) => {
                function checkClerk() {
                    if (window.Clerk === undefined) {
                        if (Date.now() - start > timeout) {
                            console.error('Clerk failed to load within timeout');
                            reject(new Error('Timeout waiting for Clerk to load'));
                            return;
                        }
                        setTimeout(checkClerk, 100);
                        return;
                    }
                    console.log('Clerk loaded successfully');
                    resolve(window.Clerk);
                }
                checkClerk();
            });
        }

        // Initialize Clerk and handle authentication
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                console.log('Initializing Clerk...');
                const Clerk = await waitForClerk();
                
                if (!Clerk) {
                    throw new Error('Clerk failed to initialize');
                }

                await Clerk.load({
                    afterLoad: (Clerk) => {
                        console.log('Clerk loaded, setting up board page...');
                    }
                });

                // Check if user is signed in
                const user = await Clerk.user;
                if (!user) {
                    console.log('User not signed in, redirecting to landing page...');
                    window.location.href = '/';
                    return;
                }


                // Mount user button
                const userButtonElement = document.getElementById('clerk-user-button');
                if (userButtonElement) {
                    await Clerk.mountUserButton(userButtonElement, {
                        afterSignOutUrl: "/",
                        appearance: {
                            elements: {
                                rootBox: "inline-block",
                                userButtonBox: "rounded-full border border-gray-200 p-1 hover:bg-gray-50 transition-colors duration-200",
                                userButtonTrigger: "flex items-center gap-2",
                                userButtonAvatarBox: "w-8 h-8 rounded-full overflow-hidden",
                                userButtonPopoverCard: "bg-white rounded-2xl shadow-lg border border-gray-100 p-6",
                                userButtonPopoverActions: "space-y-2",
                                userButtonPopoverActionButton: "w-full text-left px-4 py-2 rounded-xl hover:bg-gray-50 transition-colors duration-200"
                            }
                        }
                    });
                    console.log('Clerk user button mounted successfully');
                }

                // Setup sign out button
                const signOutBtn = document.getElementById('sign-out-btn');
                if (signOutBtn) {
                    signOutBtn.addEventListener('click', async () => {
                        try {
                            await Clerk.signOut();
                            window.location.href = '/';
                        } catch (error) {
                            console.error('Failed to sign out:', error);
                        }
                    });
                }

                // Listen for authentication state changes
                Clerk.addListener(({ user }) => {
                    if (!user) {
                        console.log('User signed out, redirecting to landing page...');
                        window.location.href = '/';
                    }
                });

                console.log('Board page authentication setup complete');

                // Initialize board components AFTER Clerk is ready
                console.log('Initializing board components...');
                if (window.boardView) {
                    console.log('Board view already initialized, triggering board data load...');
                    await window.boardView.loadBoardData();
                } else {
                    console.log('Creating new board view...');
                    window.boardView = new BoardView();
                }

            } catch (error) {
                console.error('Failed to initialize Clerk:', error.message);
                // Redirect to landing page if authentication fails
                window.location.href = '/';
            }
        });
    </script>

    <!-- Invite Modal -->
    <div id="invite-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìß Invite to Board</h3>
                <button class="modal-close" onclick="boardView.closeInviteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="invite-form">
                    <div class="form-group">
                        <label for="invite-email">Email Address *</label>
                        <input type="email" id="invite-email" name="email" required placeholder="Enter email address">
                    </div>
                    <div class="form-group">
                        <label for="invite-subject">Subject *</label>
                        <input type="text" id="invite-subject" name="subject" required placeholder="Enter email subject">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="boardView.closeInviteModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">üìß Send Email</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>